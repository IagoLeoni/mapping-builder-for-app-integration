# iPaaS Integration Builder

Uma plataforma visual de integra√ß√£o que serve como fachada "customer face" para o Google Cloud Application Integration. Permite aos clientes mapear visualmente payloads atrav√©s de uma interface drag & drop e gerar automaticamente integra√ß√µes deploy√°veis.

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ    ‚îÇ    Backend      ‚îÇ    ‚îÇ  Google Cloud   ‚îÇ
‚îÇ   (React)       ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (Node.js)     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ  Application    ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ  Integration    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes

- **Frontend**: Interface React com drag & drop para mapeamento visual
- **Backend**: API Node.js para valida√ß√£o e deployment
- **Google Cloud**: Application Integration para execu√ß√£o das integra√ß√µes

## üöÄ Funcionalidades

- ‚úÖ Interface visual drag & drop
- ‚úÖ Mapeamento de payload Gupy ‚Üí Sistema cliente
- ‚úÖ **Sistema PubSub DLQ para tratamento robusto de falhas** ‚≠ê **NOVO**
- ‚úÖ Gera√ß√£o autom√°tica de JSON de integra√ß√£o
- ‚úÖ Deploy autom√°tico no Google Cloud Application Integration
- ‚úÖ Pipeline CI/CD com Cloud Build
- ‚úÖ Monitoramento e logs de execu√ß√£o

### üîÑ **Sistema PubSub Dead Letter Queue (DLQ)** ‚≠ê **FUNCIONALIDADE CR√çTICA IMPLEMENTADA**

#### **Contexto e Necessidade Business**
Substitu√≠mos o sistema EmailTask tradicional por uma solu√ß√£o PubSub Dead Letter Queue para tratamento robusto de falhas de integra√ß√£o. Esta mudan√ßa resolve limita√ß√µes cr√≠ticas de escalabilidade e configura√ß√£o.

#### **Problema EmailTask Resolvido**
- **‚ùå Depend√™ncia email corporativa**: Configura√ß√£o SMTP complexa e espec√≠fica por cliente
- **‚ùå Limita√ß√µes de escalabilidade**: Emails n√£o s√£o ideais para processamento em lote
- **‚ùå Vari√°veis din√¢micas problem√°ticas**: Contexto de erro corrompia vari√°veis de email
- **‚ùå Falta de reprocessamento**: Emails n√£o permitem retry autom√°tico

#### **Solu√ß√£o PubSub Implementada**
- **‚úÖ Ass√≠ncrono por design**: Processamento batch, retry autom√°tico e load balancing
- **‚úÖ Infraestrutura existente**: Reutiliza connection PubSub j√° configurada
- **‚úÖ Monitoramento avan√ßado**: M√©tricas, alertas e tracking de mensagens
- **‚úÖ Payload preservado**: SystemPayload original mantido para reprocessamento

#### **Arquitetura do Sistema DLQ**

```
Webhook Gupy ‚Üí FieldMappingTask ‚Üí RestTask (Cliente)
                                      ‚Üì (falha)
                               PubSubTask (DLQ)
                                      ‚Üì
                          Topic: "dlq-pre-employee-moved"
                                      ‚Üì
                            Sistema de Reprocessamento
```

#### **Especifica√ß√µes T√©cnicas**

**Connection PubSub**:
```
projects/apigee-prd1/locations/us-central1/connections/pubsub-poc
```

**Topic DLQ**:
```
dlq-pre-employee-moved
```

**Payload DLQ**: SystemPayload completo convertido para JSON string usando fun√ß√£o nativa `TO_JSON`

**Schemas Definidos**:
- **Input Schema**: `{message: string, topic: string, attributes?: string}`
- **Output Schema**: `{messageId: string}` para tracking

#### **Fluxo de Execu√ß√£o Detalhado**

```
1. FieldMappingTask (taskId: 1) [~200ms]
   ‚îú‚îÄ Resolve systemPayload usando CONFIG_systemPayload + RESOLVE_TEMPLATE
   ‚îú‚îÄ Configura systemEndpoint usando CONFIG_systemEndpoint  
   ‚îú‚îÄ Hardcode topic "dlq-pre-employee-moved"
   ‚îî‚îÄ Converte systemPayload JSON ‚Üí String usando TO_JSON nativo
   
2. RestTask (taskId: 2) [~1-5s]
   ‚îú‚îÄ POST para endpoint do cliente com systemPayload
   ‚îú‚îÄ Headers: Content-Type: application/json, X-Integration-Source: iPaaS-Builder
   ‚îú‚îÄ Conditional Success: responseStatus = "200 OK" ‚Üí Task 5 (Success)
   ‚îî‚îÄ Conditional Failure: responseStatus != "200 OK" ‚Üí Task 4 (PubSub DLQ)

3a. SUCCESS PATH: SuccessOutputTask (taskId: 5) [~100ms]
    ‚îî‚îÄ Retorna { "Status": "Success" } para Gupy

3b. FAILURE PATH: PubSubTask (taskId: 4) [~300-500ms]
    ‚îú‚îÄ Connection: projects/apigee-prd1/locations/us-central1/connections/pubsub-poc
    ‚îú‚îÄ Action: publishMessage usando Google Cloud Connectors
    ‚îú‚îÄ Topic: "dlq-pre-employee-moved" 
    ‚îú‚îÄ Message: systemPayload convertido para JSON string
    ‚îî‚îÄ Output: messageId para tracking e monitoramento
```

#### **Vantagens T√©cnicas**

**Performance e Simplicidade**:
- ‚úÖ **Convers√£o Nativa**: TO_JSON integrado (elimina JsonnetMapperTask extra)
- ‚úÖ **Compatibilidade Total**: Mant√©m taskId 4 (zero refactoring)
- ‚úÖ **Schemas Bem Definidos**: JSON Draft-07 para validation autom√°tica

**Robustez e Monitoramento**:
- ‚úÖ **Connection Reutiliza√ß√£o**: Infraestrutura PubSub existente e testada
- ‚úÖ **Topic Dedicado**: Filtering e alertas espec√≠ficos para falhas Gupy
- ‚úÖ **Payload Preservado**: Reprocessamento com dados originais completos
- ‚úÖ **MessageId Tracking**: Rastreamento end-to-end de mensagens

**Escalabilidade e Flexibilidade**:
- ‚úÖ **Processamento Ass√≠ncrono**: Batch processing, retry autom√°tico
- ‚úÖ **Input Variable**: gupyPayload configur√°vel por cliente
- ‚úÖ **Schema Extens√≠vel**: Metadata customizada (timestamp, clientName)
- ‚úÖ **Multi-ambiente**: Connection parameteriz√°vel para dev/prod

#### **Configura√ß√£o Payload Gupy Real**

O sistema agora usa dados reais da Minerva Foods com estrutura completa:

```json
{
  "body": {
    "companyName": "Minerva Foods",
    "event": "pre-employee.moved",
    "id": "49589201-dbb3-46b7-b2d6-4f3ec16ac742",
    "date": "2025-07-03T13:22:51.239Z",
    "data": {
      "job": {
        "departmentCode": "40000605",
        "roleCode": "35251270", 
        "name": "VAGA TESTE INTEGRA√á√ÉO - Auxiliar de Produ√ß√£o",
        "department": {
          "id": 726936.0,
          "code": "40000605",
          "name": "MIUDOS DIURNO"
        }
      },
      "candidate": {
        "name": "Erica",
        "lastName": "Brugognolle", 
        "email": "ericabru@hotmail.com",
        "identificationDocument": "26962277806",
        "mobileNumber": "+5511986637567"
      },
      "admission": {
        "hiringDate": "2025-06-30T03:00:00.000Z",
        "documentsTemplate": {
          "id": 52807.0,
          "name": "Admiss√£o CLT"
        }
      },
      "position": {
        "salary": {
          "value": 3000.0,
          "currency": "R$"
        }
      }
    }
  }
}
```

#### **Evid√™ncias de Sucesso**
- ‚úÖ **Deploy Successful**: Integration JSON gerado sem erros
- ‚úÖ **PubSub Connection**: Validada e operacional no ambiente apigee-prd1
- ‚úÖ **Topic Creation**: "dlq-pre-employee-moved" criado e monitorado
- ‚úÖ **Conditional Flow**: RestTask falha ‚Üí PubSubTask executa automaticamente
- ‚úÖ **Payload Structure**: Wrapper body.data.* funcionando com dados reais

## üìã Pr√©-requisitos

- Node.js 18+
- Docker
- Google Cloud SDK
- Conta Google Cloud com Application Integration habilitado

## üõ†Ô∏è Desenvolvimento Local

### Frontend

```bash
cd frontend
npm install
npm start
```

A aplica√ß√£o estar√° dispon√≠vel em `http://localhost:3000`

### Backend

```bash
cd backend
npm install
npm run dev
```

A API estar√° dispon√≠vel em `http://localhost:8080`

### Vari√°veis de Ambiente

Crie um arquivo `.env` no diret√≥rio `backend`:

```env
NODE_ENV=development
PORT=8080
GOOGLE_CLOUD_PROJECT_ID=seu-project-id
GOOGLE_CLOUD_REGION=us-central1
FRONTEND_URL=http://localhost:3000

# Gemini AI (opcional - para mapeamento autom√°tico)
GEMINI_API_KEY=sua-api-key-do-gemini
```

### ü§ñ Configura√ß√£o do Gemini AI (Opcional)

Para habilitar o mapeamento autom√°tico com IA:

1. **Obter API Key**:
   - Acesse: https://makersuite.google.com/app/apikey
   - Crie uma nova API key
   - Copie a chave gerada

2. **Configurar no Backend**:
   ```bash
   cd backend
   echo "GEMINI_API_KEY=sua-api-key-aqui" >> .env
   ```

3. **Funcionalidades com Gemini**:
   - ‚úÖ Mapeamento autom√°tico baseado em sem√¢ntica
   - ‚úÖ Sugest√µes inteligentes de campos
   - ‚úÖ An√°lise de padr√µes de nomenclatura
   - ‚úÖ Fallback para algoritmo simples se API falhar

**Nota**: Sem a API key, o sistema usa um algoritmo de mapeamento baseado em padr√µes sem√¢nticos locais.

## üê≥ Docker

### Build Local

```bash
# Backend
docker build -t ipaas-backend ./backend

# Frontend
docker build -t ipaas-frontend ./frontend
```

### Docker Compose

```bash
docker-compose up -d
```

## ‚òÅÔ∏è Deploy no Google Cloud

### 1. Configurar Projeto

```bash
# Definir projeto
export PROJECT_ID=seu-project-id
gcloud config set project $PROJECT_ID

# Habilitar APIs necess√°rias
gcloud services enable cloudbuild.googleapis.com
gcloud services enable run.googleapis.com
gcloud services enable integrations.googleapis.com
```

### 2. Deploy via Cloud Build

```bash
# Trigger manual
gcloud builds submit --config=deployment/cloudbuild.yaml

# Ou configurar trigger autom√°tico
gcloud builds triggers create github \
  --repo-name=ipaas-integration \
  --repo-owner=seu-usuario \
  --branch-pattern="^main$" \
  --build-config=deployment/cloudbuild.yaml
```

### 3. Configurar Permiss√µes

```bash
# Service account para Application Integration
gcloud iam service-accounts create ipaas-integration \
  --display-name="iPaaS Integration Service Account"

# Adicionar roles necess√°rios
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:ipaas-integration@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/integrations.integrationAdmin"
```

## üìñ Como Usar

### 1. Acessar a Interface

Navegue at√© a URL do frontend deployado no Cloud Run.

### 2. Configurar Integra√ß√£o

1. **Email do Cliente**: Insira o email para notifica√ß√µes de erro
2. **Endpoint do Sistema**: URL do webhook do sistema cliente

### 3. Mapear Campos

1. **Painel Esquerdo**: Visualize a estrutura do payload Gupy
2. **Painel Central**: Arraste campos para criar mapeamentos
3. **Painel Direito**: Configure e visualize o JSON gerado

### 4. Deploy

Clique em "Deploy Integration" para criar a integra√ß√£o no Google Cloud.

## üßπ **LIMPEZA DE C√ìDIGO REC√âM-IMPLEMENTADA** (Agosto 2025)

### ‚úÖ **C√≥digo Otimizado e Simplificado**
O projeto passou por uma limpeza abrangente para remover c√≥digo n√£o utilizado:

- **22 arquivos/pastas removidos** (~25% redu√ß√£o no tamanho)
- **Interface simplificada** sem componentes Wizard desnecess√°rios
- **Build otimizado** para 164.01 kB (bundle final)
- **C√≥digo mais limpo** focado apenas no essencial

### üìÅ **Arquivos Removidos**
- ‚ùå Arquivos de teste manuais obsoletos (6 arquivos)
- ‚ùå Schemas duplicados e documenta√ß√£o redundante
- ‚ùå Templates Jsonnet obsoletos (pasta completa)
- ‚ùå Componentes Wizard n√£o utilizados (2 pastas completas)
- ‚ùå Templates integration obsoletos

### üéØ **Interface Otimizada**
- **Schema Input Direto**: Input JSON simplificado no MappingCanvas
- **Drag & Drop Core**: Foco na funcionalidade principal
- **Zero Depend√™ncias Mortas**: C√≥digo 100% utilizado

## üîß Estrutura do Projeto (Atualizada)

```
ipaas-integration/
‚îú‚îÄ‚îÄ frontend/                 # React frontend (otimizado)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/      # Componentes essenciais
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ConfigPanel/     # Configura√ß√£o cliente
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DebugPanel/      # Debug e monitoramento  
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JsonPreview/     # Preview integra√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MappingCanvas/   # Interface principal drag & drop
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PayloadTree/     # Visualiza√ß√£o payload Gupy
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/          # Defini√ß√µes TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/          # Utilit√°rios core
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/       # Servi√ßos frontend
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf
‚îú‚îÄ‚îÄ backend/                 # Node.js backend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/         # APIs RESTful
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deploy.ts       # Deploy integra√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gemini.ts       # Mapeamento IA
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ integration.ts  # Gest√£o integra√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transformations.ts # Preview transforma√ß√£o
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/       # Servi√ßos de neg√≥cio
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CloudBuildService.ts     # Automa√ß√£o deploy
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GeminiMappingService.ts  # IA mapeamento
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ IntegrationService.ts    # Gera√ß√£o integra√ß√£o
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ SchemaManagerService.ts  # Gest√£o schemas
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TemplateService.ts       # Sistema PubSub
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TransformationEngine.ts  # Engine transforma√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ schemas/                # Schemas e exemplos
‚îÇ   ‚îú‚îÄ‚îÄ gupy/              # Schema oficial Gupy
‚îÇ   ‚îú‚îÄ‚îÄ examples/          # Exemplos sistemas
‚îÇ   ‚îî‚îÄ‚îÄ patterns/          # Padr√µes sem√¢nticos
‚îú‚îÄ‚îÄ deployment/            # Configura√ß√µes deploy
‚îÇ   ‚îú‚îÄ‚îÄ cloudbuild.yaml   # CI/CD pipeline
‚îÇ   ‚îî‚îÄ‚îÄ integration-build.yaml # Deploy integra√ß√£o
‚îî‚îÄ‚îÄ memory-bank/          # Documenta√ß√£o t√©cnica
    ‚îú‚îÄ‚îÄ activeContext.md   # Estado atual
    ‚îú‚îÄ‚îÄ progress.md        # Progresso projeto
    ‚îî‚îÄ‚îÄ systemPatterns.md  # Padr√µes arquiteturais
```

## üîÑ Fluxo de Integra√ß√£o

1. **Cliente configura** email e endpoint
2. **Cliente mapeia** campos Gupy ‚Üí Sistema
3. **Sistema gera** JSON de integra√ß√£o
4. **Cloud Build** deploya no Application Integration
5. **Gupy envia** webhook para integra√ß√£o
6. **Integra√ß√£o processa** e envia para cliente
7. **Em caso de erro**, email √© enviado ao cliente

## üìä Monitoramento

### Logs de Execu√ß√£o

```bash
# Logs do Cloud Run
gcloud logging read "resource.type=cloud_run_revision" --limit=50

# Logs do Application Integration
gcloud logging read "resource.type=integration" --limit=50
```

### M√©tricas

- Execu√ß√µes por minuto
- Taxa de sucesso/erro
- Lat√™ncia m√©dia
- Uso de recursos

## üõ°Ô∏è Seguran√ßa

- ‚úÖ Headers de seguran√ßa configurados
- ‚úÖ Valida√ß√£o de entrada com Joi
- ‚úÖ Rate limiting
- ‚úÖ CORS configurado
- ‚úÖ Containers n√£o-root
- ‚úÖ Health checks

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch (`git checkout -b feature/nova-funcionalidade`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova funcionalidade'`)
4. Push para a branch (`git push origin feature/nova-funcionalidade`)
5. Abra um Pull Request

## üìù Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo [LICENSE](LICENSE) para detalhes.

## üÜò Suporte

Para suporte, abra uma issue no GitHub ou entre em contato com a equipe de desenvolvimento.

---

**Desenvolvido com ‚ù§Ô∏è para facilitar integra√ß√µes no Google Cloud**
